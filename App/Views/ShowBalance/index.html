{% extends "base.html" %}

{% block title %}Bilans{% endblock %}

{% block footer %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.min.js"
    integrity="sha384-7VPbUDkoPSGFnVtYi0QogXtr74QeVeeIs99Qfg5YCF+TidwNdjvaKZX19NZ/e6oz"
    crossorigin="anonymous"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script type="text/javascript">
    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(drawIncomeChart);
    google.charts.setOnLoadCallback(drawExpenseChart);

    function drawIncomeChart() {

        var incomeData = google.visualization.arrayToDataTable([
            ['Kategoria', 'Kwota'],
             {% for incomes in balance.sumGroupedIncomes %}
             ['{{incomes.name}}', {{incomes.incomeSum | number_format(2, '.','') }}],
             {% endfor %}

        ]);

        var options = {
            backgroundColor: { fill: 'transparent' },
        };

        var chart = new google.visualization.PieChart(document.getElementById('incomePiechart'));

        chart.draw(incomeData, options);
    }

    function drawExpenseChart() {

        var expenseData = google.visualization.arrayToDataTable([
            ['Kategoria', 'Kwota'],

            {% for expenses in balance.sumGroupedExpenses %}
            ['{{expenses.name}}', {{ expenses.expenseSum | number_format(2, '.', '') }}],
            {% endfor %}

        ]);

    var options = {
        backgroundColor: { fill: 'transparent' },
    };

    var chart = new google.visualization.PieChart(document.getElementById('expensePiechart'));

    chart.draw(expenseData, options);
    }
</script>

{% endblock %}

{% block body %}
    <h3>Przeglądaj bilans przychodów i wydatków</h3>
   
    <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" required>
            Wybierz okres czasu
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="/show-balance/currentMonth">obecny miesiąc</a></li>
            <li><a class="dropdown-item" href="/show-balance/previousMonth">poprzedni miesiąc</a></li>
            <li><a class="dropdown-item" href="/show-balance/currentYear">obecny rok</a></li>
            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#dateModal">wybierz zakres dat</a></li>
        </ul>
        </div>
        <div class="modal fade" role="dialog" id="dateModal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Wybierz zakres dat</h3>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="post" action="/show-balance/custom-period">
                        <div class="modal-body">
                            <label for="inputDate">zaznacz datę początkową</label>
                            <div class="form-group"><input type="date" id="inputDate" name="startDate" value="{{ current_date }}" min="2000-01-01" required></div>
                            <label for="inputDate">zaznacz datę końcową</label>
                            <div class="form-group"><input type="date" id="inputDate" name="endDate" value="{{ current_date }}"min="2000-01-01" required></div>
                        </div>
                        <div><button class="btn btn-primary" type="submit">Filtruj</button></div>
                    </form> 
                </div>
            </div>
        </div>

    {% if balance.detailedIncomes is not null or balance.detailedExpenses is not null %}
    <div id="periodTime">
        <span>{{ balance.startDate }}</span> - <span>{{ balance.endDate }}</span>
    </div>
    {% if balance.detailedIncomes is empty %}
        <div class="finance"><h4>Brak przychodów w tym okresie czasu.</h4></div>
    {% endif %}
    
    {% if balance.detailedIncomes is not empty %}
    <table class="table-sm col-lg-10 mx-auto my-2">
        <tbody>
            <thead class="thead-dark">
                <header class="summary">Przychody</header>
                <tr>
                    <th class="category">Kategoria</th>
                    <th class="date">Data</th>
                    <th class="amount">Kwota PLN</th>
                    <th class="comment">Komentarz</th>
                </tr>
            </thead>
                {% for incomes in balance.detailedIncomes %}
                <tr>
                    <td class="category">{{ incomes['name'] }}</td>
                    <td class="date">{{ incomes['date_of_income'] }}</td>
                    <td class="amount">{{ incomes['amount'] }}</td>
                    <td class="comment">{{ incomes['income_comment'] }}</td>  
                </tr>
                {% endfor %}
        </tbody>
    </table>
  
    <table class="block">
        <tbody>
            <thead>
                <header class="sumFinance">Podumowanie przychodów</header>
                <tr>
                    <th >Kategoria</th>
                    <th>Suma</th>
                </tr>
                <thead>
                {% for incomes in balance.sumGroupedIncomes %}
                <tr>
                    <td class="category">{{ incomes['name'] }}</td>
                    <td class="sum">{{ incomes['incomeSum'] }}</td>
                </tr>
                {% endfor %}
        </tbody> 
    </table>

    <div class="block">
     <div id="incomePiechart"style="width: 900px; height: 500px; margin: auto;"></div>
    </div>
        {% for incomes in balance.sumIncomes %}
            <div class="total">Suma wszystkich przychodów: {{ incomes['totalIncomeSum'] }} zł</div>
        {% endfor %}
    
    {% endif %}
  
    {% if balance.detailedExpenses is empty %}
        <div class="finance"><h4>Brak wydatków w tym okresie czasu.</h4></div>
    {% endif %}

    {% if balance.detailedExpenses is not empty %}
    <table class="table-sm col-lg-10 mx-auto my-2">
        <tbody>
            <thead class="thead-dark">
                <header class="summary">Wydatki</header>
                <tr>
                    <th class="category">Kategoria</th>
                    <th class="date">Data</th>
                    <th class="amount">Kwota PLN</th>
                    <th class="comment">Komentarz</th>
                </tr>
            </thead>
            {% for expenses in balance.detailedExpenses %}
            <tr>
                <td class="category">{{ expenses['name'] }}</td>
                <td class="date">{{ expenses['date_of_expense'] }}</td>
                <td class="amount">{{ expenses['amount'] }}</td>
                <td class="comment">{{ expenses['expense_comment'] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <table class="block">
        <tbody>
            <thead>
                <header class="sumFinance">Podumowanie wydatków</header>
                <tr>
                    <th>Kategoria</th>
                    <th>Suma</th>
                </tr>
                <thead>
                    {% for expenses in balance.sumGroupedExpenses %}
                    <tr>
                        <td class="category">{{ expenses['name'] }}</td>
                        <td class="sum">{{ expenses['expenseSum'] }}</td>
                    </tr>
                    {% endfor %}
        </tbody>
    </table>
    
    <div class="block">
        <div id="expensePiechart" style="width: 800px; height: 500px; margin: auto;"></div>
    </div>
    {% for expenses in balance.sumExpenses %}
    <div class="total">Suma wszystkich wydatków: {{ expenses['totalExpenseSum'] }} zł</div>
    {% endfor %}

    {% for incomes in balance.sumIncomes %}
    {% for expenses in balance.sumExpenses %}

        {% if (incomes['totalIncomeSum'] - expenses['totalExpenseSum']) > 0 %}
        <div class="bilans">Bilans = {{(incomes['totalIncomeSum'] - expenses['totalExpenseSum'])|number_format(2)}}</div>
        <img src="/css/img/kotSukces.jpg" style="width: 35%; height: 35%; margin-top: 30px;" />
        {% endif %}

    {% endfor %}
    {% endfor %}

    {% for incomes in balance.sumIncomes %}
    {% for expenses in balance.sumExpenses %}

        {% if (incomes['totalIncomeSum'] - expenses['totalExpenseSum']) < 0 %}
        <div class="bilans">Bilans = {{(incomes['totalIncomeSum'] - expenses['totalExpenseSum'])|number_format(2)}}</div>
        <img src="/css/img/kotWydatki.jpg" style="width: 30%; height: 30%; margin-top: 30px;" />
        {% endif %}

    {% endfor %}
    {% endfor %}

{% endif %}
{% endif %}

{% endblock %}
